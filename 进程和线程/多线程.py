'''
Pythonçš„æ ‡å‡†åº“æä¾›äº†ä¸¤ä¸ªæ¨¡å—ï¼š_threadå’Œthreadingï¼Œ_threadæ˜¯ä½çº§æ¨¡å—ï¼Œthreadingæ˜¯é«˜çº§æ¨¡å—ï¼Œå¯¹_threadè¿›è¡Œäº†å°è£…ã€‚ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ
æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨threadingè¿™ä¸ªé«˜çº§æ¨¡å—ã€‚
'''
#å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯å°†ä¸€ä¸ªå‡½æ•°ä¼ å…¥å¹¶åˆ›å»ºThreadå®ä¾‹ï¼Œç„¶åè°ƒç”¨start()å¼€å§‹æ‰§è¡Œ
import time, threading

#æ–°çº¿ç¨‹æ‰§è¡Œçš„ä»£ç 
# def loop():
#     print(f'thread {threading.current_thread().name} is running...')
#     n = 0
#     while n < 5:
#         n += 1
#         print(f'thread {threading.current_thread().name} >>> {n}')
#         time.sleep(1)
#     print(f'thread {threading.current_thread().name} ended.')
#
# print(f'thread {threading.current_thread().name}')
# t = threading.Thread(target=loop, name='LoopThread') #åˆ›å»ºThreadå®ä¾‹ï¼Œä¼ å…¥å‡½æ•°
# t.start()
# t.join()
# print(f'thread {threading.current_thread().name} ended')
'''
Pythonçš„threadingæ¨¡å—æœ‰ä¸ªcurrent_thread()å‡½æ•°ï¼Œå®ƒæ°¸è¿œè¿”å›å½“å‰çº¿ç¨‹çš„å®ä¾‹ã€‚ä¸»çº¿ç¨‹å®ä¾‹çš„åå­—å«MainThreadï¼Œå­çº¿ç¨‹çš„åå­—åœ¨åˆ›å»ºæ—¶æŒ‡å®š,
æˆ‘ä»¬ç”¨LoopThreadå‘½åå­çº¿ç¨‹ã€‚åå­—ä»…ä»…åœ¨æ‰“å°æ—¶ç”¨æ¥æ˜¾ç¤ºï¼Œå®Œå…¨æ²¡æœ‰å…¶ä»–æ„ä¹‰ï¼Œå¦‚æœä¸èµ·åå­—Pythonå°±è‡ªåŠ¨ç»™çº¿ç¨‹å‘½åä¸ºThread-1ï¼ŒThread-2â€¦â€¦
'''

'''
Lock
å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹æœ€å¤§çš„ä¸åŒåœ¨äºï¼Œå¤šè¿›ç¨‹ä¸­ï¼ŒåŒä¸€ä¸ªå˜é‡ï¼Œå„è‡ªæœ‰ä¸€ä»½æ‹·è´å­˜åœ¨äºæ¯ä¸ªè¿›ç¨‹ä¸­ï¼Œäº’ä¸å½±å“ï¼Œè€Œå¤šçº¿ç¨‹ä¸­ï¼Œæ‰€æœ‰å˜é‡éƒ½ç”±æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œ
æ‰€ä»¥ï¼Œä»»ä½•ä¸€ä¸ªå˜é‡éƒ½å¯ä»¥è¢«ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹

ä¸‹è¿°ä»£ç æ­£å¸¸è¿è¡Œæ—¶ ç»“æœbalance = 0ï¼Œä½†çº¿ç¨‹æ˜¯äº¤æ›¿è¿è¡Œçš„ï¼Œæ‰€ä»¥äº¤æ›¿è¿è¡Œå¤šæ¬¡å¯èƒ½ä¼šå‡ºé”™
åŸå› æ˜¯ä¿®æ”¹balanceéœ€è¦å¤šæ¡è¯­å¥ï¼Œè€Œæ‰§è¡Œè¿™äº›è¯­å¥æ—¶ï¼Œçº¿ç¨‹å¯èƒ½ç»ˆç«¯ï¼Œä»è€Œå¯¼è‡´å¤šä¸ªçº¿ç¨‹æŠŠåŒä¸€ä¸ªå¯¹è±¡çš„å†…å®¹æ”¹ä¹±äº†ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¸€å­˜ä¸€å–ï¼Œ
å°±å¯èƒ½å¯¼è‡´ä½™é¢ä¸å¯¹ã€‚
'''
# å‡å®šè¿™æ˜¯ä½ çš„é“¶è¡Œå­˜æ¬¾:
balance = 0
lock = threading.Lock() #åˆ›å»ºğŸ”’

def change_it(n):
    # å…ˆå­˜åå–ï¼Œç»“æœåº”è¯¥ä¸º0:
    global balance
    balance = balance + n
    balance = balance - n

def run_thread(n):
    for i in range(1000000):
        #è·å–é”
        lock.acquire()
        try:
            change_it(n)
        finally:
            #é‡Šæ”¾é”
            lock.release()

t1 = threading.Thread(target=run_thread, args=(5,))
t2 = threading.Thread(target=run_thread, args=(8,))
t1.start()
t2.start()
t1.join()
t2.join()
print(balance)

'''
å¿…é¡»ç¡®ä¿ä¸€ä¸ªçº¿ç¨‹åœ¨ä¿®æ”¹balanceçš„æ—¶å€™ï¼Œåˆ«çš„çº¿ç¨‹ä¸€å®šä¸èƒ½æ”¹åŠ¨
è¦ç»™change_it()ä¸Šä¸€æŠŠé”ï¼Œå½“æŸä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œchange_it()æ—¶ï¼Œæˆ‘ä»¬è¯´ï¼Œè¯¥çº¿ç¨‹å› ä¸ºè·å¾—äº†é”ï¼Œå› æ­¤å…¶ä»–çº¿ç¨‹ä¸èƒ½åŒæ—¶æ‰§è¡Œchange_it()ï¼Œåªèƒ½ç­‰
å¾…ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾åï¼Œè·å¾—è¯¥é”ä»¥åæ‰èƒ½æ”¹ã€‚ç”±äºé”åªæœ‰ä¸€ä¸ªï¼Œæ— è®ºå¤šå°‘çº¿ç¨‹ï¼ŒåŒä¸€æ—¶åˆ»æœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰è¯¥é”ï¼Œæ‰€ä»¥ï¼Œä¸ä¼šé€ æˆä¿®æ”¹çš„å†²çªã€‚
åˆ›å»ºä¸€ä¸ªğŸ”’æ˜¯é€šè¿‡threading.Lock()æ¥å®ç°çš„
'''
'''
å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œlock.acquire()æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸåœ°è·å–é”ï¼Œç„¶åç»§ç»­æ‰§è¡Œä»£ç ï¼Œå…¶ä»–çº¿ç¨‹å°±ç»§ç»­ç­‰å¾…ç›´åˆ°è·å¾—é”ä¸ºæ­¢ã€‚

'''

'''
Pythonçš„çº¿ç¨‹è™½ç„¶æ˜¯çœŸæ­£çš„çº¿ç¨‹ï¼Œä½†è§£é‡Šå™¨æ‰§è¡Œä»£ç æ—¶ï¼Œæœ‰ä¸€ä¸ªGILé”ï¼šGlobal Interpreter Lockï¼Œä»»ä½•Pythonçº¿ç¨‹æ‰§è¡Œå‰ï¼Œå¿…é¡»å…ˆè·å¾—GILé”ï¼Œ
ç„¶åï¼Œæ¯æ‰§è¡Œ100æ¡å­—èŠ‚ç ï¼Œè§£é‡Šå™¨å°±è‡ªåŠ¨é‡Šæ”¾GILé”ï¼Œè®©åˆ«çš„çº¿ç¨‹æœ‰æœºä¼šæ‰§è¡Œã€‚è¿™ä¸ªGILå…¨å±€é”å®é™…ä¸ŠæŠŠæ‰€æœ‰çº¿ç¨‹çš„æ‰§è¡Œä»£ç éƒ½ç»™ä¸Šäº†é”ï¼Œæ‰€ä»¥ï¼Œå¤šçº¿
ç¨‹åœ¨Pythonä¸­åªèƒ½äº¤æ›¿æ‰§è¡Œï¼Œå³ä½¿100ä¸ªçº¿ç¨‹è·‘åœ¨100æ ¸CPUä¸Šï¼Œä¹Ÿåªèƒ½ç”¨åˆ°1ä¸ªæ ¸ã€‚
'''

#æ­»å¾ªç¯
import threading, multiprocessing

def loop():
    x = 0
    while True:
        x = x ^ 1

for i in range(multiprocessing.cpu_count()):
    t = threading.Thread(target=loop)
    t.start()

#è®¡ç®—å­çº¿ç¨‹æ‰§è¡Œçš„æ—¶é—´
import threading
import time

def run(n):
    print('task', n, threading.current_thread()) #è¾“å‡ºå½“å‰çš„çº¿ç¨‹
    time.sleep(1)

#
# start_time = time.time()

import threading
import time

#ç”±äºä¸»çº¿ç¨‹æ¯”å­çº¿ç¨‹å¿«å¾ˆå¤šï¼Œå½“ä¸»çº¿ç¨‹æ‰§è¡Œactive_count()æ—¶ï¼Œå…¶ä»–å­çº¿ç¨‹éƒ½è¿˜æ²¡æ‰§è¡Œå®Œæ¯•ï¼Œå› æ­¤åˆ©ç”¨ä¸»çº¿ç¨‹ç»Ÿè®¡çš„æ´»è·ƒçš„çº¿ç¨‹æ•°
# num = sub_num(å­çº¿ç¨‹æ•°é‡)+1(ä¸»çº¿ç¨‹æœ¬èº«)
def run(n):
    print("task", n)
    time.sleep(1)       #æ­¤æ—¶å­çº¿ç¨‹åœ1s

for i in range(3):
    t = threading.Thread(target=run, args=("t-%s" % i,))
    t.start()

time.sleep(0.5)     #ä¸»çº¿ç¨‹åœ0.5ç§’
print(threading.active_count()) #è¾“å‡ºå½“å‰æ´»è·ƒçš„çº¿ç¨‹æ•°

#ç”±äºä¸»çº¿ç¨‹æ¯”å­çº¿ç¨‹æ…¢å¾ˆå¤šï¼Œå½“ä¸»çº¿ç¨‹æ‰§è¡Œactive_count()æ—¶ï¼Œå…¶ä»–å­çº¿ç¨‹éƒ½å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œå› æ­¤åˆ©ç”¨ä¸»çº¿ç¨‹ç»Ÿè®¡çš„æ´»è·ƒçš„çº¿ç¨‹æ•°num = 1(ä¸»çº¿ç¨‹æœ¬èº«)
def run(n):
    print("task", n)
    time.sleep(0.5)       #æ­¤æ—¶å­çº¿ç¨‹åœ0.5s


for i in range(3):
    t = threading.Thread(target=run, args=("t-%s" % i,))
    t.start()

time.sleep(1)     #ä¸»çº¿ç¨‹åœ1ç§’
print(threading.active_count()) #è¾“å‡ºæ´»è·ƒçš„çº¿ç¨‹



